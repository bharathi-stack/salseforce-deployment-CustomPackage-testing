# name: Salesforce CI/CD Pipeline
# on:
#   push:
#     branches:
#       - dev

# jobs:
#   # ========================================
#   # 1. FIRST JOB: Initial Process (Validate Code)
#   # ========================================
#   validate_code:
#     name: 1. Validate Code (Prettier & PMD)
#     runs-on: ubuntu-latest
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"

#       - name: Install npm dependencies
#         run: npm install

#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1

#       # --- ADDED FIX ---
#       # Force-update the CLI to repair any missing internal files
#       - name: Force-update Salesforce CLI
#         run: sf update
#       # --- END OF FIX ---

#       - name: Run Prettier code format check
#         run: npm run prettier:check
#       - name: Run PMD code scan
#         run: sfdx scanner:run --target "force-app,force-app2" --engine "pmd" --violations-cause-build-failure

#   # ========================================
#   # 2. SECOND JOB: Sandbox Validation
#   # ========================================
#   validate_sandbox:
#     name: 2. Validate against Sandbox
#     runs-on: ubuntu-latest
#     needs: validate_code

#     environment:
#       name: sandbox
#       url: ${{ steps.auth_sandbox.outputs.org_url }}

#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4

#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1

#       # --- ADDED FIX ---
#       # Force-update the CLI to repair any missing internal files
#       - name: Force-update Salesforce CLI
#         run: sf update
#       # --- END OF FIX ---

#       - name: Authenticate to Sandbox
#         id: auth_sandbox
#         run: |
#           echo "${{ secrets.SFDX_SANDBOX_AUTH_URL }}" > sfdx_auth_file.txt
#           sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a SandboxOrg -s
#           org_url=$(sfdx force:org:display -u SandboxOrg --json | jq -r .result.sfdxAuthUrl)
#           echo "org_url=$org_url" >> $GITHUB_OUTPUT

#       - name: Validate against Sandbox (RunLocalTests)
#         run: |
#           sf project deploy validate \
#             --source-dir force-app \
#             --source-dir force-app2 \
#             --target-org SandboxOrg \
#             --test-level RunLocalTests \
#             --wait 60 \
#             --verbose

#   # ========================================
#   # 3. THIRD JOB: Production Deployment
#   # ========================================
#   deploy_production:
#     name: 3. Deploy to Production
#     runs-on: ubuntu-latest
#     needs: validate_sandbox

#     environment:
#       name: production
#       url: ${{ steps.auth_prod.outputs.org_url }}

#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4

#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1

#       # --- ADDED FIX ---
#       # Force-update the CLI to repair any missing internal files
#       - name: Force-update Salesforce CLI
#         run: sf update
#       # --- END OF FIX ---

#       - name: Authenticate to Production
#         id: auth_prod
#         run: |
#           echo "${{ secrets.SFDX_PROD_AUTH_URL }}" > sfdx_auth_file.txt
#           sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a ProdOrg -s
#           org_url=$(sfdx force:org:display -u ProdOrg --json | jq -r .result.sfdxAuthUrl)
#           echo "org_url=$org_url" >> $GITHUB_OUTPUT

#       - name: Deploy to Production (RunLocalTests)
#         run: |
#           sf project deploy start \
#             --source-dir force-app \
#             --source-dir force-app2 \
#             --target-org ProdOrg \
#             --test-level RunLocalTests \
#             --wait 60 \
#             --verbose

name: Salesforce CI/CD Pipeline
on:
  push:
    branches:
      - dev

jobs:
  # ========================================
  # 1. FIRST JOB: Initial Process (Validate Code)
  # ========================================
  validate_code:
    name: 1. Validate Code (Prettier & PMD)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install npm dependencies
        run: npm install
      - name: Install Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1
      - name: Force-update Salesforce CLI
        run: sf update
      - name: Run Prettier code format check
        run: npm run prettier:check
      - name: Run PMD code scan
        run: sfdx scanner:run --target "force-app,force-app2" --engine "pmd" --violations-cause-build-failure

  # ========================================
  # 2. SECOND JOB: Validate & Deploy to Sandbox
  # ========================================
  validate_and_deploy_sandbox: # <-- RENAMED JOB
    name: 2. Validate & Deploy to Sandbox # <-- RENAMED JOB TITLE
    runs-on: ubuntu-latest
    needs: validate_code
    environment:
      name: sandbox
      url: ${{ steps.auth_sandbox.outputs.org_url }}
    outputs:
      delta_exists: ${{ steps.find_files.outputs.delta_exists }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1
      - name: Force-update Salesforce CLI
        run: sf update
      - name: Authenticate to Sandbox
        id: auth_sandbox
        run: |
          echo "${{ secrets.SFDX_SANDBOX_AUTH_URL }}" > sfdx_auth_file.txt
          sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a SandboxOrg -s
          org_url=$(sfdx force:org:display -u SandboxOrg --json | jq -r .result.sfdxAuthUrl)
          echo "org_url=$org_url" >> $GITHUB_OUTPUT
      - name: Find changed metadata files
        id: find_files
        run: |
          echo "Finding changes between HEAD~1 and HEAD"
          git diff --name-only HEAD~1 HEAD > changed-files.txt
          echo "--- All changed files ---"
          cat changed-files.txt
          echo "-------------------------"
          grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
          echo "--- Salesforce changes ---"
          cat salesforce-changes.txt
          echo "--------------------------"
          if [ -s salesforce-changes.txt ]; then
            echo "Salesforce changes detected."
            echo "delta_exists=true" >> $GITHUB_OUTPUT
          else
            echo "No Salesforce metadata changes detected. Skipping validation."
            echo "delta_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate Delta against Sandbox
        if: steps.find_files.outputs.delta_exists == 'true'
        id: validate_delta # <-- Added an ID to this step
        run: |
          echo "Validating delta changes..."
          SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')
          if [ -z "$SOURCE_PATHS" ]; then echo "No paths to validate."; exit 0; fi
          echo "Validating paths: $SOURCE_PATHS"

          # *** MODIFICATION ***
          # Run with --json to capture the output to a file
          sf project deploy validate \
            $SOURCE_PATHS \
            --target-org SandboxOrg \
            --test-level RunLocalTests \
            --wait 60 \
            --verbose \
            --json > validation-result.json

          echo "--- Validation Result JSON ---"
          cat validation-result.json
          echo "------------------------------"

          # Check status and extract Job ID
          STATUS=$(jq -r .status validation-result.json)
          if [ "$STATUS" -eq 0 ]; then
            VALIDATION_ID=$(jq -r .result.id validation-result.json)
            echo "Validation successful. Job ID: $VALIDATION_ID"
            # Save the Job ID for the next step
            echo "validation_id=$VALIDATION_ID" >> $GITHUB_OUTPUT 
          else
            echo "Validation failed."
            # Print error details from Salesforce
            jq -r ".result | .message" validation-result.json
            exit 1 # Fail the job
          fi

      # *** NEW STEP ***
      - name: Deploy Delta to Sandbox (Quick Deploy)
        # This step only runs if the 'validate_delta' step was successful and output a validation_id
        if: steps.validate_delta.outputs.validation_id
        run: |
          echo "Validation complete. Proceeding with quick deploy to Sandbox."
          sf project deploy quick \
            --job-id ${{ steps.validate_delta.outputs.validation_id }} \
            --target-org SandboxOrg \
            --verbose

  # ========================================
  # 3. THIRD JOB: Production Deployment
  # ========================================
  deploy_production:
    name: 3. Deploy to Production
    runs-on: ubuntu-latest
    needs: validate_and_deploy_sandbox # <-- UPDATED: Now depends on the new sandbox job
    # This job will still only run if the delta exists, which is good practice
    if: needs.validate_and_deploy_sandbox.outputs.delta_exists == 'true' # <-- UPDATED
    environment:
      name: production
      url: ${{ steps.auth_prod.outputs.org_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1
      - name: Force-update Salesforce CLI
        run: sf update
      - name: Authenticate to Production
        id: auth_prod
        run: |
          echo "${{ secrets.SFDX_PROD_AUTH_URL }}" > sfdx_auth_file.txt
          sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a ProdOrg -s
          org_url=$(sfdx force:org:display -u ProdOrg --json | jq -r .result.sdofxAuthUrl)
          echo "org_url=$org_url" >> $GITHUB_OUTPUT

      - name: Find changed metadata files for Prod
        id: find_files_prod
        run: |
          echo "Finding changes between HEAD~1 and HEAD"
          git diff --name-only HEAD~1 HEAD > changed-files.txt
          grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
          echo "--- Salesforce changes to deploy ---"
          cat salesforce-changes.txt
          echo "------------------------------------"
          if [ ! -s salesforce-changes.txt ]; then
            echo "No Salesforce metadata changes detected. This is unexpected."
          fi

      - name: Deploy Delta to Production
        run: |
          echo "Deploying delta changes to Production..."
          SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')
          if [ -z "$SOURCE_PATHS" ]; then
            echo "No paths to deploy. This is unexpected as the job should have been skipped."
            exit 1
          fi

          echo "Deploying paths: $SOURCE_PATHS"

          # This is the full deployment command, which runs tests again (best practice for Prod)
          sf project deploy start \
            $SOURCE_PATHS \
            --target-org ProdOrg \
            --test-level RunLocalTests \
            --wait 60 \
            --verbose

# # delta for sandbox

# name: Salesforce CI/CD Pipeline
# on:
#   push:
#     branches:
#       - dev

# jobs:
#   # ========================================
#   # 1. FIRST JOB: Initial Process (Validate Code)
#   # ========================================
#   validate_code:
#     name: 1. Validate Code (Prettier & PMD)
#     runs-on: ubuntu-latest
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4
#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"
#       - name: Install npm dependencies
#         run: npm install
#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1
#       - name: Force-update Salesforce CLI
#         run: sf update
#       - name: Run Prettier code format check
#         run: npm run prettier:check
#       - name: Run PMD code scan
#         run: sfdx scanner:run --target "force-app,force-app2" --engine "pmd" --violations-cause-build-failure

#   # ========================================
#   # 2. SECOND JOB: Generate Delta & Validate
#   # ========================================
#   validate_sandbox:
#     name: 2. Generate Delta & Validate
#     runs-on: ubuntu-latest
#     needs: validate_code
#     environment:
#       name: sandbox
#       url: ${{ steps.auth_sandbox.outputs.org_url }}
#     outputs:
#       delta_exists: ${{ steps.find_files.outputs.delta_exists }}
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1
#       - name: Force-update Salesforce CLI
#         run: sf update
#       - name: Authenticate to Sandbox
#         id: auth_sandbox
#         run: |
#           echo "${{ secrets.SFDX_SANDBOX_AUTH_URL }}" > sfdx_auth_file.txt
#           sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a SandboxOrg -s
#           org_url=$(sfdx force:org:display -u SandboxOrg --json | jq -r .result.sfdxAuthUrl)
#           echo "org_url=$org_url" >> $GITHUB_OUTPUT
#       - name: Find changed metadata files
#         id: find_files
#         run: |
#           echo "Finding changes between HEAD~1 and HEAD"
#           git diff --name-only HEAD~1 HEAD > changed-files.txt
#           echo "--- All changed files ---"
#           cat changed-files.txt
#           echo "-------------------------"
#           grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
#           echo "--- Salesforce changes ---"
#           cat salesforce-changes.txt
#           echo "--------------------------"
#           if [ -s salesforce-changes.txt ]; then
#             echo "Salesforce changes detected."
#             echo "delta_exists=true" >> $GITHUB_OUTPUT
#           else
#             echo "No Salesforce metadata changes detected. Skipping validation."
#             echo "delta_exists=false" >> $GITHUB_OUTPUT
#           fi

#       - name: Validate Delta against Sandbox
#         if: steps.find_files.outputs.delta_exists == 'true'
#         run: |
#           echo "Validating delta changes..."

#           # This job correctly uses the delta
#           SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')

#           if [ -z "$SOURCE_PATHS" ]; then
#             echo "No paths to validate."
#             exit 0
#           fi

#           echo "Validating paths: $SOURCE_PATHS"

#           sf project deploy validate \
#             $SOURCE_PATHS \
#             --target-org SandboxOrg \
#             --test-level RunLocalTests \
#             --wait 60 \
#             --verbose

#   # ========================================
#   # 3. THIRD JOB: Production Deployment
#   # ========================================
#   deploy_production:
#     name: 3. Deploy to Production
#     runs-on: ubuntu-latest
#     needs: validate_sandbox
#     # This job will still only run if the delta exists, which is good practice
#     if: needs.validate_sandbox.outputs.delta_exists == 'true'
#     environment:
#       name: production
#       url: ${{ steps.auth_prod.outputs.org_url }}
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4
#         with:
#           # We don't need fetch-depth: 0 anymore since we aren't diffing
#           fetch-depth: 1
#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1
#       - name: Force-update Salesforce CLI
#         run: sf update
#       - name: Authenticate to Production
#         id: auth_prod
#         run: |
#           echo "${{ secrets.SFDX_PROD_AUTH_URL }}" > sfdx_auth_file.txt
#           sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a ProdOrg -s
#           org_url=$(sfdx force:org:display -u ProdOrg --json | jq -r .result.sfdxAuthUrl)
#           echo "org_url=$org_url" >> $GITHUB_OUTPUT

#       # *** MODIFICATION HERE ***
#       # Removed the "Find changed metadata files for Prod" step
#       # The step below now deploys the *full* source paths, not the delta.

#       - name: Deploy Full Source to Production
#         run: |
#           echo "Deploying all metadata from force-app and force-app2 to Production..."

#           sf project deploy start \
#             --source-dir force-app \
#             --source-dir force-app2 \
#             --target-org ProdOrg \
#             --test-level RunLocalTests \
#             --wait 60 \
#             --verbose
