# -----------------------------------------------------------------------------------------------------------------

# name: Salesforce CI/CD Pipeline
# on:
#   push:
#     branches:
#       - dev

# jobs:
#   # ========================================
#   # 1. FIRST JOB: Initial Process (Validate Code)
#   # ========================================
#   validate_code:
#     name: Pre Validation (Prettier & Scanner)
#     runs-on: ubuntu-latest
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"

#       - name: Install npm dependencies
#         run: npm install

#       - name: Install Salesforce CLI
#         run: |
#           npm install --global @salesforce/cli
#           sf --version

#       - name: Install Salesforce Scanner Plugin
#         run: sf plugins install @salesforce/sfdx-scanner

#       - name: Run Prettier code format check
#         id: prettier_check
#         run: npm run prettier:check
#         continue-on-error: true

#       - name: Run Code Analyzer (PMD, Security, etc.)
#         id: scanner_run
#         run: |
#           sf scanner run --target force-app --target force-app2 \
#             --outfile CodeAnalyzerReport.html \
#             --format html \
#             --severity-threshold 2
#         continue-on-error: true

#       - name: Upload Code Analyzer Report
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: code-analyzer-report
#           path: CodeAnalyzerReport.html
#           retention-days: 30

#       - name: Check Scan Results
#         if: always()
#         run: |
#           if [ "${{ steps.prettier_check.outcome }}" == "failure" ]; then
#             echo "::error::Prettier check failed."
#           fi

#           if [ "${{ steps.scanner_run.outcome }}" == "failure" ]; then
#             echo "::error::Code Scanner found violations (severity 2+). See uploaded report."
#           fi

#           if [ "${{ steps.prettier_check.outcome }}" == "failure" ] || [ "${{ steps.scanner_run.outcome }}" == "failure" ]; then
#             exit 1
#           fi

#   # ========================================
#   # 2. NEW JOB: Validate & Deploy to QA
#   # ========================================
#   qa_deployment:
#     name: Deploy to QA
#     runs-on: ubuntu-latest
#     needs: validate_code
#     environment:
#       name: qa
#       url: ${{ steps.auth_qa.outputs.org_url }}
#     outputs:
#       delta_exists: ${{ steps.find_files.outputs.delta_exists }}
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1
#       - name: Force-update Salesforce CLI
#         run: sf update
#       - name: Authenticate to QA Org
#         id: auth_qa
#         run: |
#           echo "${{ secrets.SFDX_QA_AUTH_URL }}" > sfdx_auth_file.txt
#           sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a QAOrg -s
#           org_url=$(sfdx force:org:display -u QAOrg --json | jq -r .result.sfdxAuthUrl)
#           echo "org_url=$org_url" >> $GITHUB_OUTPUT
#       - name: Find changed metadata files
#         id: find_files
#         run: |
#           echo "Finding changes between HEAD~1 and HEAD"
#           git diff --name-only HEAD~1 HEAD > changed-files.txt
#           grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
#           echo "--- Salesforce changes ---"
#           cat salesforce-changes.txt
#           echo "--------------------------"
#           if [ -s salesforce-changes.txt ]; then
#             echo "Salesforce changes detected."
#             echo "delta_exists=true" >> $GITHUB_OUTPUT
#           else
#             echo "No Salesforce metadata changes detected. Skipping validation."
#             echo "delta_exists=false" >> $GITHUB_OUTPUT
#           fi
#       - name: Validate Delta against QA Org
#         if: steps.find_files.outputs.delta_exists == 'true'
#         id: validate_delta_qa
#         run: |
#           echo "Validating delta changes against QA Org..."
#           SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')
#           if [ -z "$SOURCE_PATHS" ]; then echo "No paths to validate."; exit 0; fi

#           echo "Validating paths: $SOURCE_PATHS"

#           VALIDATION_JSON=$(sf project deploy validate \
#             $SOURCE_PATHS \
#             --target-org QAOrg \
#             --test-level RunLocalTests \
#             --wait 60 \
#             --verbose \
#             --json) || true

#           echo "--- QA Validation Result JSON ---"
#           echo "$VALIDATION_JSON" | jq .
#           echo "---------------------------------"

#           STATUS=$(echo "$VALIDATION_JSON" | jq -r .status)

#           if [ "$STATUS" -eq 0 ]; then
#             echo "Validation successful."
#             VALIDATION_ID=$(echo "$VALIDATION_JSON" | jq -r .result.id)
#             echo "validation_id=$VALIDATION_ID" >> $GITHUB_OUTPUT

#             # TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
#             # TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
#             # LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)

#             # echo "Total Lines: $TOTAL_LINES"
#             # echo "Lines Covered: $LINES_COVERED"

#             # if [ "$TOTAL_LINES" -gt 0 ]; then
#             #   echo "########################"
#             #   COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
#             #   echo "--- Overall Code Coverage ---"
#             #   echo "Lines Covered: $LINES_COVERED / $TOTAL_LINES"
#             #   echo "COVERAGE: $COVERAGE_PERCENT%"
#             #   echo "-----------------------------"
#             # fi

#             TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
#             # Calculate overall coverage from codeCoverage array
#             TOTAL_LINES=$(echo "$TEST_RESULT" | jq '[.codeCoverage[]? | .numLocations] | add // 0')
#             LINES_NOT_COVERED=$(echo "$TEST_RESULT" | jq '[.codeCoverage[]? | .numLocationsNotCovered] | add // 0')
#             LINES_COVERED=$((TOTAL_LINES - LINES_NOT_COVERED))

#             echo "Test Result: $TEST_RESULT"
#             echo "Total Lines: $TOTAL_LINES"
#             echo "Lines Covered: $LINES_COVERED"

#             if [ "$TOTAL_LINES" -gt 0 ]; then
#               COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
#               echo "--- Overall Code Coverage ---"
#               echo "Lines Covered: $LINES_COVERED / $TOTAL_LINES"
#               echo "COVERAGE: $COVERAGE_PERCENT%"
#               echo "-----------------------------"
#             fi

#             # Check individual class coverage
#             echo "--- Checking Individual Class Coverage ---"
#             CHANGED_APEX=$(grep -E "\.cls$" salesforce-changes.txt | grep -v "Test\.cls$" || true)

#             if [ -n "$CHANGED_APEX" ]; then
#               FAILED_CLASSES=""
#               while IFS= read -r apex_file; do
#                 CLASS_NAME=$(basename "$apex_file" .cls)
#                 CLASS_COVERAGE=$(echo "$TEST_RESULT" | jq -r --arg name "$CLASS_NAME" \
#                   '.codeCoverage[] | select(.name == $name) |
#                   if .numLocations > 0 then ((.numLocationsNotCovered / .numLocations) * 100 | 100 - .) else 0 end')

#                 if [ -n "$CLASS_COVERAGE" ] && [ "$CLASS_COVERAGE" != "null" ]; then
#                   COVERAGE_INT=${CLASS_COVERAGE%.*}
#                   echo "Class: $CLASS_NAME - Coverage: ${COVERAGE_INT}%"

#                   if [ "$COVERAGE_INT" -lt 75 ]; then
#                     FAILED_CLASSES="$FAILED_CLASSES\n   - $CLASS_NAME: ${COVERAGE_INT}%"
#                   fi
#                 fi
#               done <<< "$CHANGED_APEX"

#               if [ -n "$FAILED_CLASSES" ]; then
#                 echo "::error::The following classes have insufficient coverage (< 75%):"
#                 echo -e "$FAILED_CLASSES"
#                 exit 1
#               fi
#             fi
#             echo "------------------------------------------"

#           else
#             echo "Validation FAILED. Parsing results..."

#             TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)

#             if [ "$TEST_RESULT" != "null" ]; then
#               NUM_TESTS=$(echo "$TEST_RESULT" | jq -r .numTestsRun)
#               NUM_FAILED=$(echo "$TEST_RESULT" | jq -r .numFailures)

#               echo "--- Test Run Summary (Failure) ---"
#               echo "Total Tests Run: $NUM_TESTS"
#               echo "Total Failures: $NUM_FAILED"

#               if [ "$NUM_FAILED" -gt 0 ]; then
#                 echo "--- Failing Tests ---"
#                 echo "$TEST_RESULT" | jq -r '.failures[] | "   - \(.name): \(.message)"'
#                 echo "---------------------"
#               fi

#               TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
#               LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)

#               if [ "$TOTAL_LINES" -gt 0 ]; then
#                 COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
#                 echo "--- Code Coverage ---"
#                 echo "Total Lines: $TOTAL_LINES"
#                 echo "Lines Covered: $LINES_COVERED"
#                 echo "COVERAGE: $COVERAGE_PERCENT%"

#                 if [ "$COVERAGE_PERCENT" -lt 75 ]; then
#                   echo "ERROR: Code coverage is $COVERAGE_PERCENT%. Minimum required is 75%."
#                 fi
#                 echo "---------------------"
#               else
#                 echo "No lines found for coverage calculation."
#               fi
#             fi

#             COMP_FAILURES=$(echo "$VALIDATION_JSON" | jq .result.details.componentFailures)
#             if [ "$COMP_FAILURES" != "null" ] && [ "$(echo "$COMP_FAILURES" | jq 'length')" -gt 0 ]; then
#               echo "--- Component Failures (Compilation Errors) ---"
#               echo "$COMP_FAILURES" | jq -r '.[] | "   - \(.problemType): \(.fileName) - \(.problem)"'
#               echo "-----------------------------------------------"
#             fi

#             exit 1
#           fi
#       - name: Deploy Delta to QA Org (Quick Deploy)
#         if: steps.validate_delta_qa.outputs.validation_id
#         run: |
#           echo "Validation complete. Proceeding with quick deploy to QA Org."
#           sf project deploy quick \
#             --job-id ${{ steps.validate_delta_qa.outputs.validation_id }} \
#             --target-org QAOrg \
#             --verbose

#   # ========================================
#   # 3. THIRD JOB: Validate & Deploy to Sandbox
#   # ========================================
#   staging_deployment:
#     name: Deploy to staging
#     runs-on: ubuntu-latest
#     needs: qa_deployment
#     if: needs.qa_deployment.outputs.delta_exists == 'true'
#     environment:
#       name: sandbox
#       url: ${{ steps.auth_sandbox.outputs.org_url }}
#     outputs:
#       delta_exists: ${{ steps.find_files.outputs.delta_exists }}
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1
#       - name: Force-update Salesforce CLI
#         run: sf update
#       - name: Authenticate to Sandbox
#         id: auth_sandbox
#         run: |
#           echo "${{ secrets.SFDX_SANDBOX_AUTH_URL }}" > sfdx_auth_file.txt
#           sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a SandboxOrg -s
#           org_url=$(sfdx force:org:display -u SandboxOrg --json | jq -r .result.sfdxAuthUrl)
#           echo "org_url=$org_url" >> $GITHUB_OUTPUT
#       - name: Find changed metadata files
#         id: find_files
#         run: |
#           echo "Finding changes between HEAD~1 and HEAD"
#           git diff --name-only HEAD~1 HEAD > changed-files.txt
#           grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
#           echo "--- Salesforce changes ---"
#           cat salesforce-changes.txt
#           echo "--------------------------"
#           if [ -s salesforce-changes.txt ]; then
#             echo "Salesforce changes detected."
#             echo "delta_exists=true" >> $GITHUB_OUTPUT
#           else
#             echo "No Salesforce metadata changes detected. Skipping validation."
#             echo "delta_exists=false" >> $GITHUB_OUTPUT
#           fi
#       - name: Validate Delta against Sandbox
#         if: steps.find_files.outputs.delta_exists == 'true'
#         id: validate_delta_sandbox
#         run: |
#           echo "Validating delta changes against Sandbox..."
#           SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')
#           if [ -z "$SOURCE_PATHS" ]; then echo "No paths to validate."; exit 0; fi

#           echo "Validating paths: $SOURCE_PATHS"

#           VALIDATION_JSON=$(sf project deploy validate \
#             $SOURCE_PATHS \
#             --target-org SandboxOrg \
#             --test-level RunLocalTests \
#             --wait 60 \
#             --verbose \
#             --json) || true

#           echo "--- Sandbox Validation Result JSON ---"
#           echo "$VALIDATION_JSON" | jq .
#           echo "--------------------------------------"

#           STATUS=$(echo "$VALIDATION_JSON" | jq -r .status)

#           if [ "$STATUS" -eq 0 ]; then
#             echo "Validation successful."
#             VALIDATION_ID=$(echo "$VALIDATION_JSON" | jq -r .result.id)
#             echo "validation_id=$VALIDATION_ID" >> $GITHUB_OUTPUT

#             TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
#             TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
#             LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)

#             if [ "$TOTAL_LINES" -gt 0 ]; then
#               COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
#               echo "--- Overall Code Coverage ---"
#               echo "Lines Covered: $LINES_COVERED / $TOTAL_LINES"
#               echo "COVERAGE: $COVERAGE_PERCENT%"
#               echo "-----------------------------"
#             fi

#             # Check individual class coverage
#             echo "--- Checking Individual Class Coverage ---"
#             CHANGED_APEX=$(grep -E "\.cls$" salesforce-changes.txt | grep -v "Test\.cls$" || true)

#             if [ -n "$CHANGED_APEX" ]; then
#               FAILED_CLASSES=""
#               while IFS= read -r apex_file; do
#                 CLASS_NAME=$(basename "$apex_file" .cls)
#                 CLASS_COVERAGE=$(echo "$TEST_RESULT" | jq -r --arg name "$CLASS_NAME" \
#                   '.codeCoverage[] | select(.name == $name) |
#                   if .numLocations > 0 then ((.numLocationsNotCovered / .numLocations) * 100 | 100 - .) else 0 end')

#                 if [ -n "$CLASS_COVERAGE" ] && [ "$CLASS_COVERAGE" != "null" ]; then
#                   COVERAGE_INT=${CLASS_COVERAGE%.*}
#                   echo "Class: $CLASS_NAME - Coverage: ${COVERAGE_INT}%"

#                   if [ "$COVERAGE_INT" -lt 75 ]; then
#                     FAILED_CLASSES="$FAILED_CLASSES\n   - $CLASS_NAME: ${COVERAGE_INT}%"
#                   fi
#                 fi
#               done <<< "$CHANGED_APEX"

#               if [ -n "$FAILED_CLASSES" ]; then
#                 echo "::error::The following classes have insufficient coverage (< 75%):"
#                 echo -e "$FAILED_CLASSES"
#                 exit 1
#               fi
#             fi
#             echo "------------------------------------------"

#           else
#             echo "Validation FAILED. Parsing results..."

#             TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)

#             if [ "$TEST_RESULT" != "null" ]; then
#               NUM_TESTS=$(echo "$TEST_RESULT" | jq -r .numTestsRun)
#               NUM_FAILED=$(echo "$TEST_RESULT" | jq -r .numFailures)

#               echo "--- Test Run Summary (Failure) ---"
#               echo "Total Tests Run: $NUM_TESTS"
#               echo "Total Failures: $NUM_FAILED"

#               if [ "$NUM_FAILED" -gt 0 ]; then
#                 echo "--- Failing Tests ---"
#                 echo "$TEST_RESULT" | jq -r '.failures[] | "   - \(.name): \(.message)"'
#                 echo "---------------------"
#               fi

#               TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
#               LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)

#               if [ "$TOTAL_LINES" -gt 0 ]; then
#                 COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
#                 echo "--- Code Coverage ---"
#                 echo "Total Lines: $TOTAL_LINES"
#                 echo "Lines Covered: $LINES_COVERED"
#                 echo "COVERAGE: $COVERAGE_PERCENT%"

#                 if [ "$COVERAGE_PERCENT" -lt 75 ]; then
#                   echo "ERROR: Code coverage is $COVERAGE_PERCENT%. Minimum required is 75%."
#                 fi
#                 echo "---------------------"
#               else
#                 echo "No lines found for coverage calculation."
#               fi
#             fi

#             COMP_FAILURES=$(echo "$VALIDATION_JSON" | jq .result.details.componentFailures)
#             if [ "$COMP_FAILURES" != "null" ] && [ "$(echo "$COMP_FAILURES" | jq 'length')" -gt 0 ]; then
#               echo "--- Component Failures (Compilation Errors) ---"
#               echo "$COMP_FAILURES" | jq -r '.[] | "   - \(.problemType): \(.fileName) - \(.problem)"'
#               echo "-----------------------------------------------"
#             fi

#             exit 1
#           fi
#       - name: Deploy Delta to Sandbox (Quick Deploy)
#         if: steps.validate_delta_sandbox.outputs.validation_id
#         run: |
#           echo "Validation complete. Proceeding with quick deploy to Sandbox."
#           sf project deploy quick \
#             --job-id ${{ steps.validate_delta_sandbox.outputs.validation_id }} \
#             --target-org SandboxOrg \
#             --verbose

#   # ========================================
#   # 4. FOURTH JOB: Production Deployment
#   # ========================================
#   deploy_production:
#     name: Deploy to Production
#     runs-on: ubuntu-latest
#     needs: staging_deployment
#     if: needs.staging_deployment.outputs.delta_exists == 'true'
#     environment:
#       name: production
#       url: ${{ steps.auth_prod.outputs.org_url }}
#     steps:
#       - name: Check out code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#       - name: Install Salesforce CLI
#         uses: sfdx-actions/setup-sfdx@v1
#       - name: Force-update Salesforce CLI
#         run: sf update
#       - name: Authenticate to Production
#         id: auth_prod
#         run: |
#           echo "${{ secrets.SFDX_PROD_AUTH_URL }}" > sfdx_auth_file.txt
#           sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a ProdOrg -s
#           org_url=$(sfdx force:org:display -u ProdOrg --json | jq -r .result.sfdxAuthUrl)
#           echo "org_url=$org_url" >> $GITHUB_OUTPUT
#       - name: Find changed metadata files for Prod
#         id: find_files_prod
#         run: |
#           echo "Finding changes between HEAD~1 and HEAD"
#           git diff --name-only HEAD~1 HEAD > changed-files.txt
#           grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
#           echo "--- Salesforce changes to deploy ---"
#           cat salesforce-changes.txt
#           echo "------------------------------------"
#           if [ ! -s salesforce-changes.txt ]; then
#             echo "No Salesforce metadata changes detected. This is unexpected."
#           fi
#       - name: Validate Delta against Production
#         id: validate_delta_prod
#         run: |
#           echo "Validating delta changes against Production..."
#           SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')
#           if [ -z "$SOURCE_PATHS" ]; then
#             echo "No paths to validate. This is unexpected as the job should have been skipped."
#             exit 1
#           fi

#           echo "Validating paths: $SOURCE_PATHS"

#           VALIDATION_JSON=$(sf project deploy validate \
#             $SOURCE_PATHS \
#             --target-org ProdOrg \
#             --test-level RunLocalTests \
#             --wait 60 \
#             --verbose \
#             --json) || true

#           echo "--- Production Validation Result JSON ---"
#           echo "$VALIDATION_JSON" | jq .
#           echo "-----------------------------------------"

#           STATUS=$(echo "$VALIDATION_JSON" | jq -r .status)

#           if [ "$STATUS" -eq 0 ]; then
#             echo "Production validation successful."
#             VALIDATION_ID=$(echo "$VALIDATION_JSON" | jq -r .result.id)
#             echo "validation_id=$VALIDATION_ID" >> $GITHUB_OUTPUT

#             TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
#             TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
#             LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)

#             if [ "$TOTAL_LINES" -gt 0 ]; then
#               COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
#               echo "--- Overall Code Coverage ---"
#               echo "Lines Covered: $LINES_COVERED / $TOTAL_LINES"
#               echo "COVERAGE: $COVERAGE_PERCENT%"
#               echo "-----------------------------"
#             fi

#             # Check individual class coverage
#             echo "--- Checking Individual Class Coverage ---"
#             CHANGED_APEX=$(grep -E "\.cls$" salesforce-changes.txt | grep -v "Test\.cls$" || true)

#             if [ -n "$CHANGED_APEX" ]; then
#               FAILED_CLASSES=""
#               while IFS= read -r apex_file; do
#                 CLASS_NAME=$(basename "$apex_file" .cls)
#                 CLASS_COVERAGE=$(echo "$TEST_RESULT" | jq -r --arg name "$CLASS_NAME" \
#                   '.codeCoverage[] | select(.name == $name) |
#                   if .numLocations > 0 then ((.numLocationsNotCovered / .numLocations) * 100 | 100 - .) else 0 end')

#                 if [ -n "$CLASS_COVERAGE" ] && [ "$CLASS_COVERAGE" != "null" ]; then
#                   COVERAGE_INT=${CLASS_COVERAGE%.*}
#                   echo "Class: $CLASS_NAME - Coverage: ${COVERAGE_INT}%"

#                   if [ "$COVERAGE_INT" -lt 75 ]; then
#                     FAILED_CLASSES="$FAILED_CLASSES\n   - $CLASS_NAME: ${COVERAGE_INT}%"
#                   fi
#                 fi
#               done <<< "$CHANGED_APEX"

#               if [ -n "$FAILED_CLASSES" ]; then
#                 echo "::error::The following classes have insufficient coverage (< 75%):"
#                 echo -e "$FAILED_CLASSES"
#                 exit 1
#               fi
#             fi
#             echo "------------------------------------------"

#           else
#             echo "Production validation FAILED. Parsing results..."

#             TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)

#             if [ "$TEST_RESULT" != "null" ]; then
#               NUM_TESTS=$(echo "$TEST_RESULT" | jq -r .numTestsRun)
#               NUM_FAILED=$(echo "$TEST_RESULT" | jq -r .numFailures)

#               echo "--- Test Run Summary (Failure) ---"
#               echo "Total Tests Run: $NUM_TESTS"
#               echo "Total Failures: $NUM_FAILED"

#               if [ "$NUM_FAILED" -gt 0 ]; then
#                 echo "--- Failing Tests ---"
#                 echo "$TEST_RESULT" | jq -r '.failures[] | "   - \(.name): \(.message)"'
#                 echo "---------------------"
#               fi

#               TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
#               LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)

#               if [ "$TOTAL_LINES" -gt 0 ]; then
#                 COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
#                 echo "--- Code Coverage ---"
#                 echo "Total Lines: $TOTAL_LINES"
#                 echo "Lines Covered: $LINES_COVERED"
#                 echo "COVERAGE: $COVERAGE_PERCENT%"

#                 if [ "$COVERAGE_PERCENT" -lt 75 ]; then
#                   echo "ERROR: Code coverage is $COVERAGE_PERCENT%. Minimum required is 75%."
#                 fi
#                 echo "---------------------"
#               else
#                 echo "No lines found for coverage calculation."
#               fi
#             fi

#             COMP_FAILURES=$(echo "$VALIDATION_JSON" | jq .result.details.componentFailures)
#             if [ "$COMP_FAILURES" != "null" ] && [ "$(echo "$COMP_FAILURES" | jq 'length')" -gt 0 ]; then
#               echo "--- Component Failures (Compilation Errors) ---"
#               echo "$COMP_FAILURES" | jq -r '.[] | "   - \(.problemType): \(.fileName) - \(.problem)"'
#               echo "-----------------------------------------------"
#             fi

#             exit 1
#           fi
#       - name: Deploy Delta to Production (Quick Deploy)
#         if: steps.validate_delta_prod.outputs.validation_id
#         run: |
#           echo "Production validation complete. Proceeding with quick deploy to Production."
#           sf project deploy quick \
#             --job-id ${{ steps.validate_delta_prod.outputs.validation_id }} \
#             --target-org ProdOrg \
#             --verbose

# -----------------------------------------------------------------------------------------------------------------------------------------------

name: Salesforce CI/CD Pipeline
on:
  push:
    branches:
      - dev

jobs:
  # ========================================
  # 1. FIRST JOB: Initial Process (Validate Code)
  # ========================================
  validate_code:
    name: Pre Validation (Prettier & Scanner) # Renamed job
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install npm dependencies
        run: npm install

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Install Salesforce Scanner Plugin
        run: sf plugins install @salesforce/sfdx-scanner

      # --- STEP 1: Run Prettier (Same as before) ---
      - name: Run Prettier code format check
        id: prettier_check
        run: npm run prettier:check
        continue-on-error: true # Allows workflow to continue

      # --- STEP 2: COMBINED SCANNER STEP (This is the fix) ---
      # This one command runs all default engines (including PMD)
      # and saves ALL results to the HTML file.
      - name: Run Code Analyzer (PMD, Security, etc.)
        id: scanner_run # Give it an ID
        run: |
          sf scanner run --target force-app --target force-app2 \
            --outfile CodeAnalyzerReport.html \
            --format html \
            --severity-threshold 2
        continue-on-error: true # IMPORTANT: This lets the next step run

      # --- STEP 3: Upload Report (Same as before) ---
      # This will now find the HTML file *with* all the PMD violations in it
      - name: Upload Code Analyzer Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-analyzer-report
          path: CodeAnalyzerReport.html
          retention-days: 30

      # --- STEP 4: Check Results (Updated) ---
      # This step now checks BOTH the prettier and scanner steps
      - name: Check Scan Results
        if: always()
        run: |
          if [ "${{ steps.prettier_check.outcome }}" == "failure" ]; then
            echo "::error::Prettier check failed."
          fi

          # Check the outcome of our new scanner_run step
          if [ "${{ steps.scanner_run.outcome }}" == "failure" ]; then
            echo "::error::Code Scanner found violations (severity 2+). See uploaded report."
          fi

          # If EITHER step failed, fail the whole job
          if [ "${{ steps.prettier_check.outcome }}" == "failure" ] || [ "${{ steps.scanner_run.outcome }}" == "failure" ]; then
            exit 1
          fi
  # ========================================
  # 2. NEW JOB: Validate & Deploy to QA
  # ========================================
  qa_deployment:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: validate_code
    environment:
      name: qa
      url: ${{ steps.auth_qa.outputs.org_url }}
    outputs:
      delta_exists: ${{ steps.find_files.outputs.delta_exists }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1

      - name: Force-update Salesforce CLI
        run: sf update

      - name: Authenticate to QA Org
        id: auth_qa
        run: |
          echo "${{ secrets.SFDX_QA_AUTH_URL }}" > sfdx_auth_file.txt
          sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a QAOrg -s
          org_url=$(sfdx force:org:display -u QAOrg --json | jq -r .result.sfdxAuthUrl)
          echo "org_url=$org_url" >> $GITHUB_OUTPUT

      # STEP 1: Check existing org code coverage using Tooling API
      - name: Check Existing Org Code Coverage (90% Requirement)
        id: check_org_coverage
        run: |
          echo "======================================================"
          echo "STEP 1: Checking existing org code coverage (90% requirement)"
          echo "======================================================"
          echo ""

          # Query all ApexCodeCoverage records from the org
          COVERAGE_QUERY="SELECT ApexClassOrTriggerId, NumLinesCovered, NumLinesUncovered FROM ApexCodeCoverageAggregate"

          COVERAGE_RESULT=$(sf data query \
            --query "$COVERAGE_QUERY" \
            --target-org QAScratchOrg \
            --json) || true

          echo "$COVERAGE_RESULT" | jq . > org_coverage.json

          # Extract coverage data
          RECORDS=$(echo "$COVERAGE_RESULT" | jq -r '.result.records // []')
          NUM_RECORDS=$(echo "$RECORDS" | jq 'length')

          if [ "$NUM_RECORDS" -eq 0 ]; then
            echo "⚠️  WARNING: No code coverage data found in org."
            echo "This could mean:"
            echo "  1. No Apex classes exist in the org yet"
            echo "  2. No tests have been run in the org"
            echo ""
            echo "Skipping existing coverage check."
            echo "org_has_apex=false" >> $GITHUB_OUTPUT
          else
            echo "Found coverage data for $NUM_RECORDS classes/triggers"
            echo ""
            
            # Calculate total coverage
            TOTAL_LINES=$(echo "$RECORDS" | jq '[.[] | (.NumLinesCovered + .NumLinesUncovered)] | add')
            COVERED_LINES=$(echo "$RECORDS" | jq '[.[] | .NumLinesCovered] | add')
            
            echo "--- Existing Org Code Coverage ---"
            echo "Total Lines: $TOTAL_LINES"
            echo "Lines Covered: $COVERED_LINES"
            
            if [ "$TOTAL_LINES" -gt 0 ]; then
              COVERAGE_PERCENT=$((100 * COVERED_LINES / TOTAL_LINES))
              echo "Coverage: $COVERAGE_PERCENT%"
              echo "Requirement: 90%"
              echo "-----------------------------------"
              echo ""
              
              if [ "$COVERAGE_PERCENT" -lt 90 ]; then
                echo "❌ ERROR: Existing org code coverage is $COVERAGE_PERCENT%"
                echo "Minimum required: 90%"
                echo ""
                echo "Please run all tests and ensure 90% coverage before deploying:"
                echo "  sf apex run test --target-org QAOrg --test-level RunLocalTests --wait 60"
                exit 1
              else
                echo "✓ Existing org code meets 90% coverage requirement"
                echo "org_has_apex=true" >> $GITHUB_OUTPUT
              fi
            else
              echo "Coverage: 0%"
              echo "-----------------------------------"
              echo ""
              echo "❌ ERROR: Org has Apex classes but 0% coverage"
              echo "Please run tests to establish baseline coverage."
              exit 1
            fi
          fi

      - name: Find changed metadata files
        id: find_files
        run: |
          echo ""
          echo "======================================================"
          echo "STEP 2: Identifying changed files"
          echo "======================================================"

          git diff --name-only HEAD~1 HEAD > changed-files.txt
          grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true

          echo "--- Changed Files ---"
          if [ -s salesforce-changes.txt ]; then
            cat salesforce-changes.txt
            echo "---------------------"
            echo ""
            echo "✓ Salesforce changes detected"
            echo "delta_exists=true" >> $GITHUB_OUTPUT
          else
            echo "(none)"
            echo "---------------------"
            echo ""
            echo "⚠️  No Salesforce metadata changes detected"
            echo "delta_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for Apex changes
        if: steps.find_files.outputs.delta_exists == 'true'
        id: check_apex
        run: |
          echo ""
          echo "======================================================"
          echo "STEP 3: Checking for Apex class changes"
          echo "======================================================"

          # Check if any changed files are Apex classes (not test classes)
          if grep -E "\.cls$" salesforce-changes.txt | grep -v -i "test\.cls$" > apex-changes.txt 2>/dev/null; then
            echo "--- Changed Apex Classes ---"
            cat apex-changes.txt
            echo "----------------------------"
            echo ""
            echo "✓ Apex class changes detected"
            echo "has_apex_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No Apex class changes detected (metadata or test classes only)"
            echo ""
            echo "has_apex_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate Delta against QA Org
        if: steps.find_files.outputs.delta_exists == 'true'
        id: validate_delta_qa
        run: |
          echo ""
          echo "======================================================"
          echo "STEP 4: Validating delta changes"
          echo "======================================================"

          SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')

          if [ -z "$SOURCE_PATHS" ]; then
            echo "No paths to validate"
            exit 0
          fi

          echo "Validating: $SOURCE_PATHS"
          echo ""

          VALIDATION_JSON=$(sf project deploy validate \
            $SOURCE_PATHS \
            --target-org QAOrg \
            --test-level RunLocalTests \
            --wait 60 \
            --verbose \
            --json) || true
            
          echo "$VALIDATION_JSON" | jq . > delta_validation.json

          STATUS=$(echo "$VALIDATION_JSON" | jq -r '.status // 1')
          TEST_RESULT=$(echo "$VALIDATION_JSON" | jq '.result.details.runTestResult')

          TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r '.totalLines // 0')
          LINES_COVERED=$(echo "$TEST_RESULT" | jq -r '.linesCovered // 0')

          HAS_APEX="${{ steps.check_apex.outputs.has_apex_changes }}"

          if [ "$STATUS" -eq 0 ]; then
            echo "✓ Delta validation syntax check successful"
            
            VALIDATION_ID=$(echo "$VALIDATION_JSON" | jq -r '.result.id')
            echo "validation_id=$VALIDATION_ID" >> $GITHUB_OUTPUT
            
            echo ""
            echo "--- Delta Validation Code Coverage ---"
            echo "Total Lines: $TOTAL_LINES"
            echo "Lines Covered: $LINES_COVERED"
            
            if [ "$TOTAL_LINES" -gt 0 ]; then
              COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
              echo "Coverage: $COVERAGE_PERCENT%"
              echo "---------------------------------------"
              echo ""
              
              # Check 1: If Apex changed, new classes must have 75% coverage
              if [ "$HAS_APEX" = "true" ]; then
                echo "Checking new Apex class coverage (75% requirement)..."
                
                # Get coverage for changed classes only
                CHANGED_CLASSES=$(grep -E "\.cls$" salesforce-changes.txt | grep -v -i "test\.cls$" | sed 's|.*/||' | sed 's|\.cls||' | sort -u)
                
                if [ -n "$CHANGED_CLASSES" ]; then
                  echo "Changed non-test classes:"
                  echo "$CHANGED_CLASSES"
                  echo ""
                  
                  # Check each changed class coverage
                  ALL_CLASSES_PASS=true
                  while IFS= read -r class_name; do
                    if [ -n "$class_name" ]; then
                      CLASS_COVERAGE=$(echo "$TEST_RESULT" | jq -r \
                        --arg name "$class_name" \
                        '.codeCoverage[]? | select(.name == $name) | 
                        if .numLocations > 0 then 
                          (((.numLocations - .numLocationsNotCovered) * 100) / .numLocations | floor) 
                        else 0 end')
                      
                      if [ -n "$CLASS_COVERAGE" ] && [ "$CLASS_COVERAGE" != "null" ]; then
                        if [ "$CLASS_COVERAGE" -lt 75 ]; then
                          echo "  ❌ $class_name: ${CLASS_COVERAGE}% (< 75%)"
                          ALL_CLASSES_PASS=false
                        else
                          echo "  ✓ $class_name: ${CLASS_COVERAGE}%"
                        fi
                      else
                        echo "  ⚠️  $class_name: No coverage data (might be interface/abstract)"
                      fi
                    fi
                  done <<< "$CHANGED_CLASSES"
                  
                  echo ""
                  
                  if [ "$ALL_CLASSES_PASS" = "false" ]; then
                    echo "❌ ERROR: Some new Apex classes have less than 75% coverage"
                    echo "Each new/modified Apex class must have at least 75% coverage"
                    exit 1
                  else
                    echo "✓ All new Apex classes meet 75% coverage requirement"
                  fi
                fi
              fi
              
              # Check 2: Overall coverage must be 90%
              echo ""
              echo "Checking overall post-deployment coverage (90% requirement)..."
              
              if [ "$COVERAGE_PERCENT" -lt 90 ]; then
                echo "❌ ERROR: Overall coverage after deployment is $COVERAGE_PERCENT%"
                echo "Minimum required: 90%"
                echo ""
                echo "This validation ran all tests and measured overall org coverage."
                echo "The combination of existing and new code must maintain 90% coverage."
                exit 1
              else
                echo "✓ Overall coverage meets 90% requirement ($COVERAGE_PERCENT%)"
              fi
              
            elif [ "$HAS_APEX" = "true" ]; then
              # Apex was changed but no coverage data
              echo "Coverage: N/A"
              echo "---------------------------------------"
              echo ""
              echo "⚠️  WARNING: Apex classes were modified but no coverage data returned"
              echo "This might mean:"
              echo "  1. Only test classes were modified (no coverage needed)"
              echo "  2. Changes are to interfaces/abstract classes"
              echo ""
              echo "Proceeding with deployment..."
            else
              # No Apex changes, just metadata
              echo "Coverage: N/A (metadata only)"
              echo "---------------------------------------"
              echo ""
              echo "✓ Metadata-only deployment (no coverage check required)"
            fi
            
          else
            echo "❌ Delta validation FAILED"
            echo ""
            
            if [ "$TEST_RESULT" != "null" ]; then
              NUM_TESTS=$(echo "$TEST_RESULT" | jq -r '.numTestsRun // 0')
              NUM_FAILED=$(echo "$TEST_RESULT" | jq -r '.numFailures // 0')
              
              echo "--- Test Summary ---"
              echo "Tests Run: $NUM_TESTS"
              echo "Failures: $NUM_FAILED"
              echo "--------------------"
              echo ""
              
              if [ "$NUM_FAILED" -gt 0 ]; then
                echo "--- Failing Tests ---"
                echo "$TEST_RESULT" | jq -r '.failures[]? | "  ❌ \(.name): \(.message)"'
                echo "---------------------"
                echo ""
              fi
              
              if [ "$TOTAL_LINES" -gt 0 ]; then
                COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
                echo "--- Code Coverage ---"
                echo "Total Lines: $TOTAL_LINES"
                echo "Lines Covered: $LINES_COVERED"
                echo "Coverage: $COVERAGE_PERCENT%"
                echo "---------------------"
                echo ""
              fi
            fi
            
            COMP_FAILURES=$(echo "$VALIDATION_JSON" | jq '.result.details.componentFailures')
            if [ "$COMP_FAILURES" != "null" ] && [ "$(echo "$COMP_FAILURES" | jq 'length')" -gt 0 ]; then
              echo "--- Component Failures ---"
              echo "$COMP_FAILURES" | jq -r '.[]? | "  ❌ \(.problemType): \(.fileName) - \(.problem)"'
              echo "--------------------------"
              echo ""
            fi
            
            exit 1
          fi

      - name: Deploy Delta to QA Org (Quick Deploy)
        if: steps.validate_delta_qa.outputs.validation_id
        run: |
          echo ""
          echo "======================================================"
          echo "STEP 5: Deploying to QA Org"
          echo "======================================================"
          echo ""
          echo "✓ All validations passed. Proceeding with quick deploy..."
          echo ""

          sf project deploy quick \
            --job-id ${{ steps.validate_delta_qa.outputs.validation_id }} \
            --target-org QAOrg \
            --verbose

          echo ""
          echo "✓ Deployment completed successfully!"

  # ========================================
  # 3. THIRD JOB: Validate & Deploy to Sandbox
  # ========================================
  staging_deployment:
    name: Deploy to staging
    runs-on: ubuntu-latest
    needs: qa_deployment # <--- MODIFIED: Now runs after the 'qa_deployment' job
    if: needs.qa_deployment.outputs.delta_exists == 'true' # Ensures we skip if QA found no delta
    environment:
      name: sandbox
      url: ${{ steps.auth_sandbox.outputs.org_url }}
    outputs:
      delta_exists: ${{ steps.find_files.outputs.delta_exists }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1
      - name: Force-update Salesforce CLI
        run: sf update
      - name: Authenticate to Sandbox
        id: auth_sandbox
        run: |
          echo "${{ secrets.SFDX_SANDBOX_AUTH_URL }}" > sfdx_auth_file.txt
          sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a SandboxOrg -s
          org_url=$(sfdx force:org:display -u SandboxOrg --json | jq -r .result.sfdxAuthUrl)
          echo "org_url=$org_url" >> $GITHUB_OUTPUT
      - name: Find changed metadata files
        id: find_files
        run: |
          echo "Finding changes between HEAD~1 and HEAD"
          git diff --name-only HEAD~1 HEAD > changed-files.txt
          grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
          echo "--- Salesforce changes ---"
          cat salesforce-changes.txt
          echo "--------------------------"
          if [ -s salesforce-changes.txt ]; then
            echo "Salesforce changes detected."
            echo "delta_exists=true" >> $GITHUB_OUTPUT
          else
            echo "No Salesforce metadata changes detected. Skipping validation."
            echo "delta_exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Validate Delta against Sandbox
        if: steps.find_files.outputs.delta_exists == 'true'
        id: validate_delta_sandbox
        run: |
          echo "Validating delta changes against Sandbox..."
          SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')
          if [ -z "$SOURCE_PATHS" ]; then echo "No paths to validate."; exit 0; fi

          echo "Validating paths: $SOURCE_PATHS"

          VALIDATION_JSON=$(sf project deploy validate \
            $SOURCE_PATHS \
            --target-org SandboxOrg \
            --test-level RunLocalTests \
            --wait 60 \
            --verbose \
            --json) || true
            
          echo "--- Sandbox Validation Result JSON ---"
          echo "$VALIDATION_JSON" | jq .
          echo "--------------------------------------"

          STATUS=$(echo "$VALIDATION_JSON" | jq -r .status)

          if [ "$STATUS" -eq 0 ]; then
            echo "Validation successful."
            VALIDATION_ID=$(echo "$VALIDATION_JSON" | jq -r .result.id)
            echo "validation_id=$VALIDATION_ID" >> $GITHUB_OUTPUT
            
            TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
            TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
            LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)
            
            if [ "$TOTAL_LINES" -gt 0 ]; then
              COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
              echo "--- Code Coverage (Success) ---"
              echo "Lines Covered: $LINES_COVERED / $TOTAL_LINES"
              echo "COVERAGE: $COVERAGE_PERCENT%"
              echo "-------------------------------"
            fi
            
          else
            echo "Validation FAILED. Parsing results..."
            
            TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
            
            if [ "$TEST_RESULT" != "null" ]; then
              NUM_TESTS=$(echo "$TEST_RESULT" | jq -r .numTestsRun)
              NUM_FAILED=$(echo "$TEST_RESULT" | jq -r .numFailures)
              
              echo "--- Test Run Summary (Failure) ---"
              echo "Total Tests Run: $NUM_TESTS"
              echo "Total Failures: $NUM_FAILED"
              
              if [ "$NUM_FAILED" -gt 0 ]; then
                echo "--- Failing Tests ---"
                echo "$TEST_RESULT" | jq -r '.failures[] | "   - \(.name): \(.message)"'
                echo "---------------------"
              fi

              TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
              LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)
              
              if [ "$TOTAL_LINES" -gt 0 ]; then
                COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
                echo "--- Code Coverage ---"
                echo "Total Lines: $TOTAL_LINES"
                echo "Lines Covered: $LINES_COVERED"
                echo "COVERAGE: $COVERAGE_PERCENT%"
                
                if [ "$COVERAGE_PERCENT" -lt 75 ]; then
                  echo "ERROR: Code coverage is $COVERAGE_PERCENT%. Minimum required is 75%."
                fi
                echo "---------------------"
              else
                echo "No lines found for coverage calculation."
              fi
            fi
            
            COMP_FAILURES=$(echo "$VALIDATION_JSON" | jq .result.details.componentFailures)
            if [ "$COMP_FAILURES" != "null" ] && [ "$(echo "$COMP_FAILURES" | jq 'length')" -gt 0 ]; then
              echo "--- Component Failures (Compilation Errors) ---"
              echo "$COMP_FAILURES" | jq -r '.[] | "   - \(.problemType): \(.fileName) - \(.problem)"'
              echo "-----------------------------------------------"
            fi
            
            exit 1 # Fail the job
          fi
      - name: Deploy Delta to Sandbox (Quick Deploy)
        if: steps.validate_delta_sandbox.outputs.validation_id
        run: |
          echo "Validation complete. Proceeding with quick deploy to Sandbox."
          sf project deploy quick \
            --job-id ${{ steps.validate_delta_sandbox.outputs.validation_id }} \
            --target-org SandboxOrg \
            --verbose

  # ========================================
  # 4. FOURTH JOB: Production Deployment
  # ========================================
  deploy_production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: staging_deployment # <--- This remains correct
    if: needs.staging_deployment.outputs.delta_exists == 'true' # <--- This remains correct
    environment:
      name: production
      url: ${{ steps.auth_prod.outputs.org_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1
      - name: Force-update Salesforce CLI
        run: sf update
      - name: Authenticate to Production
        id: auth_prod
        run: |
          echo "${{ secrets.SFDX_PROD_AUTH_URL }}" > sfdx_auth_file.txt
          sfdx auth:sfdxurl:store -f sfdx_auth_file.txt -a ProdOrg -s
          org_url=$(sfdx force:org:display -u ProdOrg --json | jq -r .result.sfdxAuthUrl)
          echo "org_url=$org_url" >> $GITHUB_OUTPUT
      - name: Find changed metadata files for Prod
        id: find_files_prod
        run: |
          echo "Finding changes between HEAD~1 and HEAD"
          git diff --name-only HEAD~1 HEAD > changed-files.txt
          grep -E "(force-app/|force-app2/|sfdx-project.json)" changed-files.txt > salesforce-changes.txt || true
          echo "--- Salesforce changes to deploy ---"
          cat salesforce-changes.txt
          echo "------------------------------------"
          if [ ! -s salesforce-changes.txt ]; then
            echo "No Salesforce metadata changes detected. This is unexpected."
          fi
      - name: Validate Delta against Production
        id: validate_delta_prod
        run: |
          echo "Validating delta changes against Production..."
          SOURCE_PATHS=$(cat salesforce-changes.txt | sed 's_^_ -d _' | tr '\n' ' ')
          if [ -z "$SOURCE_PATHS" ]; then
            echo "No paths to validate. This is unexpected as the job should have been skipped."
            exit 1
          fi

          echo "Validating paths: $SOURCE_PATHS"

          VALIDATION_JSON=$(sf project deploy validate \
            $SOURCE_PATHS \
            --target-org ProdOrg \
            --test-level RunLocalTests \
            --wait 60 \
            --verbose \
            --json) || true

          echo "--- Production Validation Result JSON ---"
          echo "$VALIDATION_JSON" | jq .
          echo "-----------------------------------------"

          STATUS=$(echo "$VALIDATION_JSON" | jq -r .status)

          if [ "$STATUS" -eq 0 ]; then
            echo "Production validation successful."
            VALIDATION_ID=$(echo "$VALIDATION_JSON" | jq -r .result.id)
            echo "validation_id=$VALIDATION_ID" >> $GITHUB_OUTPUT
            
            TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
            TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
            LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)
            
            if [ "$TOTAL_LINES" -gt 0 ]; then
              COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
              echo "--- Code Coverage (Success) ---"
              echo "Lines Covered: $LINES_COVERED / $TOTAL_LINES"
              echo "COVERAGE: $COVERAGE_PERCENT%"
              echo "-------------------------------"
            fi
            
          else
            echo "Production validation FAILED. Parsing results..."
            
            TEST_RESULT=$(echo "$VALIDATION_JSON" | jq .result.details.runTestResult)
            
            if [ "$TEST_RESULT" != "null" ]; then
              NUM_TESTS=$(echo "$TEST_RESULT" | jq -r .numTestsRun)
              NUM_FAILED=$(echo "$TEST_RESULT" | jq -r .numFailures)
              
              echo "--- Test Run Summary (Failure) ---"
              echo "Total Tests Run: $NUM_TESTS"
              echo "Total Failures: $NUM_FAILED"
              
              if [ "$NUM_FAILED" -gt 0 ]; then
                echo "--- Failing Tests ---"
                echo "$TEST_RESULT" | jq -r '.failures[] | "   - \(.name): \(.message)"'
                echo "---------------------"
              fi

              TOTAL_LINES=$(echo "$TEST_RESULT" | jq -r .totalLines)
              LINES_COVERED=$(echo "$TEST_RESULT" | jq -r .linesCovered)
              
              if [ "$TOTAL_LINES" -gt 0 ]; then
                COVERAGE_PERCENT=$((100 * LINES_COVERED / TOTAL_LINES))
                echo "--- Code Coverage ---"
                echo "Total Lines: $TOTAL_LINES"
                echo "Lines Covered: $LINES_COVERED"
                echo "COVERAGE: $COVERAGE_PERCENT%"
                
                if [ "$COVERAGE_PERCENT" -lt 75 ]; then
                  echo "ERROR: Code coverage is $COVERAGE_PERCENT%. Minimum required is 75%."
                fi
                echo "---------------------"
              else
                echo "No lines found for coverage calculation."
              fi
            fi
            
            COMP_FAILURES=$(echo "$VALIDATION_JSON" | jq .result.details.componentFailures)
            if [ "$COMP_FAILURES" != "null" ] && [ "$(echo "$COMP_FAILURES" | jq 'length')" -gt 0 ]; then
              echo "--- Component Failures (Compilation Errors) ---"
              echo "$COMP_FAILURES" | jq -r '.[] | "   - \(.problemType): \(.fileName) - \(.problem)"'
              echo "-----------------------------------------------"
            fi
            
            exit 1 # Fail the job
          fi
      - name: Deploy Delta to Production (Quick Deploy)
        if: steps.validate_delta_prod.outputs.validation_id
        run: |
          echo "Production validation complete. Proceeding with quick deploy to Production."
          sf project deploy quick \
            --job-id ${{ steps.validate_delta_prod.outputs.validation_id }} \
            --target-org ProdOrg \
            --verbose
